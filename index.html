<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Sistema Login - Fundación Kinal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="css/style.css" />
</head>
<body>
<header class="header">
    <img src="img/kinal-logo-2.png" alt="Logo Fundación Kinal" />
    <span>Fundación Kinal</span>
</header>

<div id="main-content">
    <div class="login-container" id="login-container">
        <h2>Iniciar Sesión</h2>
        <form id="login-form" autocomplete="off">
            <input type="email" name="email" placeholder="Email" required />
            <input type="password" name="clave" placeholder="Contraseña" required />
            <div class="error-message" id="login-error"></div>
            <button type="submit">Entrar</button>
        </form>
        <button class="switch-link" id="show-register">¿No tienes cuenta? Regístrate</button>
    </div>

    <div class="login-container" id="register-container" style="display:none;">
        <h2>Registrarse</h2>
        <form id="register-form" autocomplete="off">
            <input type="text" name="nombre" placeholder="Nombre" required />
            <input type="text" name="apellido" placeholder="Apellido" required />
            <input type="email" name="email" placeholder="Email" required />
            <input type="password" name="clave" placeholder="Contraseña" required />
            <input type="password" name="clave2" placeholder="Repetir Contraseña" required />
            <div class="error-message" id="register-error"></div>
            <button type="submit">Registrarse</button>
        </form>
        <button class="switch-link" id="show-login">¿Ya tienes cuenta? Inicia sesión</button>
    </div>
</div>

<div id="welcome-screen"></div>

<script>
    const mainContent = document.getElementById('main-content');
    const loginContainer = document.getElementById('login-container');
    const registerContainer = document.getElementById('register-container');
    const showRegisterBtn = document.getElementById('show-register');
    const showLoginBtn = document.getElementById('show-login');
    const welcomeScreen = document.getElementById('welcome-screen');

    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');
    const registerForm = document.getElementById('register-form');
    const registerError = document.getElementById('register-error');

    const BACKEND_URL = 'https://proyectoexpkinal.onrender.com/api'; 

    showRegisterBtn.addEventListener('click', () => {
        loginContainer.style.display = 'none';
        registerContainer.style.display = 'block';
        clearMessages();
    });

    showLoginBtn.addEventListener('click', () => {
        registerContainer.style.display = 'none';
        loginContainer.style.display = 'block';
        clearMessages();
    });

    function clearMessages() {
        loginError.textContent = '';
        registerError.textContent = '';
    }

    function showWelcome(userDisplayName) {
        mainContent.classList.add('slide-out-left');
        setTimeout(() => {
            mainContent.style.display = 'none';

            welcomeScreen.textContent = `BIENVENIDO ${userDisplayName.toUpperCase()}`;
            welcomeScreen.classList.add('show');

            setTimeout(() => {
                welcomeScreen.classList.remove('show');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 500);
            }, 3000);
        }, 800);
    }

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = loginForm.email.value.trim();
        const clave = loginForm.clave.value.trim();

        clearMessages();

        try {
            const response = await fetch(`${BACKEND_URL}/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, clave })
            });

            const data = await response.json();

            if (response.ok) {
                localStorage.setItem('logueado', 'si');
                localStorage.setItem('usuario_actual', JSON.stringify(data.user));
                showWelcome(data.user.nombre);
            } else {
                loginError.textContent = data.message || 'Error al iniciar sesión. Intenta de nuevo.';
            }
        } catch (error) {
            console.error('Error de red o servidor:', error);
            loginError.textContent = 'No se pudo conectar con el servidor. Asegúrate de que el backend esté corriendo.';
        }
    });

    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const nombre = registerForm.nombre.value.trim();
        const apellido = registerForm.apellido.value.trim();
        const email = registerForm.email.value.trim();
        const clave = registerForm.clave.value.trim();
        const clave2 = registerForm.clave2.value.trim();

        clearMessages();

        if (clave !== clave2) {
            registerError.textContent = 'Las contraseñas no coinciden.';
            return;
        }

        if (!nombre || !apellido || !email || !clave) {
            registerError.textContent = 'Por favor, llena todos los campos.';
            return;
        }

        try {
            const response = await fetch(`${BACKEND_URL}/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ nombre, apellido, email, clave })
            });

            const data = await response.json();

            if (response.ok) {
                localStorage.setItem('logueado', 'si');
                localStorage.setItem('usuario_actual', JSON.stringify(data.user));
                showWelcome(data.user.nombre);
                registerForm.reset();
            } else {
                registerError.textContent = data.message || 'Error al registrar usuario. Intenta de nuevo.';
            }
        } catch (error) {
            console.error('Error de red o servidor:', error);
            registerError.textContent = 'No se pudo conectar con el servidor. Asegúrate de que el backend esté corriendo.';
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const usuarioActual = JSON.parse(localStorage.getItem('usuario_actual'));
        if (localStorage.getItem('logueado') === 'si' && usuarioActual && usuarioActual.nombre) {
            showWelcome(usuarioActual.nombre);
        } else {
            loginContainer.style.display = 'block';
            registerContainer.style.display = 'none';
        }
    });
</script>
</body>
</html>